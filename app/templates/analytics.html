<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <title>Analytics</title>
  <link rel="stylesheet" href="{% static 'css/analytics.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div class="analytics-container">

    <!-- Header -->
    <div class="analytics-header">
      <div>
        <h2>{{ url.title }}</h2>
        <p class="subtitle">Link analytics overview</p>
      </div>
      <a href="{% url 'list' %}" class="back-link">‚Üê Back</a>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-label">Total Clicks</span>
        <span class="stat-value">{{ total_clicks }}</span>
      </div>

      <div class="stat-card">
        <span class="stat-label">Last Clicked</span>
        <span class="stat-value">
          {% if last_click %}
            {{ last_click|timesince }} ago
          {% else %}
            Never
          {% endif %}
        </span>
      </div>

      <div class="stat-card">
        <span class="stat-label">Status</span>
        <span class="stat-value {% if url.is_active %}active{% else %}disabled{% endif %}">
          {% if url.is_active %}Active{% else %}Disabled{% endif %}
        </span>
      </div>
    </div>

  <div class="range-selector">
  <a href="?range=7"
     class="range-btn {% if current_range == '7' %}active{% endif %}">
    Last 7 days
  </a>

  <a href="?range=30"
     class="range-btn {% if current_range == '30' %}active{% endif %}">
    Last 30 days
  </a>

  <a href="?range=all"
     class="range-btn {% if current_range == 'all' %}active{% endif %}">
    All time
  </a>

  <form method="get" class="date-range-form">
    <input type="date" name="start" value="{{ start }}">
    <input type="date" name="end" value="{{ end }}">
    <button type="submit">Apply</button>
  </form>


</div>


    <!-- Chart -->
    <div class="analytics-card chart-small">
      <div class="chart-header">
        <h3>Clicks Over Time</h3>
        <span class="chart-subtitle">Daily engagement</span>
      </div>
      <canvas id="clickChart"></canvas>
    </div>

  </div>

  <div class="analytics-card chart-samll chart-pie">
    <h3>Device Distribution</h3>
    {%if device_counts%}
    <canvas id="deviceChart" height="220"></canvas>
    {%else%}
    <p>No devices data for this range.</p>
    {%endif%}
  </div>

  <script>
    const ctx = document.getElementById("clickChart");

    new Chart(ctx, {
      type: "line",
      data: {
        labels: {{ days|safe }},
        datasets: [{
          data: {{ counts|safe }},
          borderColor: "#60a5fa",
          backgroundColor: "rgba(96,165,250,0.15)",
          tension: 0.35,
          fill: true,
          pointRadius: 3,
          pointHoverRadius: 6,
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: "#9ca3af" }
          },
          y: {
            beginAtZero: true,
            ticks: {
              color: "#9ca3af",
              precision: 0
            }
          }
        }
      }
    });
  </script>

<script>
  const deviceCtx = document
    .getElementById("deviceChart")
    .getContext("2d");

  new Chart(deviceCtx, {
    type: "pie",
    data: {
      labels: {{ device_labels|safe }},
      datasets: [{
        data: {{ device_counts|safe }},
        backgroundColor: [
          "#60a5fa", // Mobile
          "#34d399", // Desktop
          "#fbbf24", // Tablet
          "#f87171"  // Unknown
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: "bottom",
          labels: {
            color: "#e5e7eb",
            padding: 16
          }
        }
      }
    }
  });
</script>

</body>
</html>
